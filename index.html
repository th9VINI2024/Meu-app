<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Music</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
:root{
  --bg:#0b1d3a;
  --bg2:#061126;
  --accent:#38bdf8;
  --text:#fff;
}

*{box-sizing:border-box;font-family:system-ui,Arial}
body{
  margin:0;
  background:linear-gradient(180deg,var(--bg),var(--bg2));
  color:var(--text);
}

header{padding:16px;font-size:22px;font-weight:600}

.tabs{display:flex;gap:18px;padding:0 16px 12px}
.tab{opacity:.5;cursor:pointer}
.tab.active{opacity:1;border-bottom:2px solid var(--accent);padding-bottom:4px}

.search{padding:0 16px 10px}
.search input{
  width:100%;
  padding:10px 14px;
  border-radius:20px;
  border:none;
}

.list{padding:8px;padding-bottom:120px}
.track{
  display:flex;
  gap:12px;
  padding:10px;
  border-radius:12px;
}
.track:hover{background:rgba(255,255,255,.08)}
.cover{
  width:48px;height:48px;
  border-radius:8px;
  background:#1f2937;
  display:flex;
  align-items:center;
  justify-content:center;
}
.info{flex:1}
.title{font-size:15px}
.artist{font-size:12px;opacity:.7}

.player{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#020617;
  padding:10px;
}
audio{width:100%}

.addBtn{
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%);
  width:56px;height:56px;
  border-radius:50%;
  background:var(--accent);
  color:#000;
  font-size:34px;
  border:none;
}
</style>
</head>

<body>

<header>M√∫sicas</header>

<div class="tabs">
  <div class="tab active" onclick="setTab('tracks',event)">Faixas</div>
  <div class="tab" onclick="setTab('artists',event)">Artistas</div>
</div>

<div class="search">
  <input type="text" placeholder="Buscar..." oninput="search(this.value)">
</div>

<div class="list" id="list"></div>

<div class="player">
  <div class="cover" id="cover">üéµ</div>
  <audio id="audio" controls></audio>
</div>

<button class="addBtn" onclick="file.click()">+</button>
<input type="file" id="file" accept="audio/*" multiple hidden>

<script>
let db, tracks=[];
const list=document.getElementById("list");
const audio=document.getElementById("audio");
const file=document.getElementById("file");

/* IndexedDB */
const req=indexedDB.open("MusicDB",1);
req.onupgradeneeded=e=>{
  e.target.result.createObjectStore("tracks",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadDB();
};

function loadDB(){
  tracks=[];
  const tx=db.transaction("tracks","readonly");
  tx.objectStore("tracks").openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(c){tracks.push(c.value);c.continue();}
    else renderTracks(tracks);
  };
}

file.onchange = () => {
  [...file.files].forEach(file => {
    jsmediatags.read(file, {
      onSuccess: tag => {
        const tags = tag.tags;

        let cover = null;
        if (tags.picture) {
          const { data, format } = tags.picture;
          let base64 = "";
          data.forEach(byte => base64 += String.fromCharCode(byte));
          cover = `data:${format};base64,${btoa(base64)}`;
        }

        const reader = new FileReader();
        reader.onload = async () => {
          await saveMusic({
  title: tags.title || file.name,
  artist: tags.artist || "Desconhecido",
  album: tags.album || "",
  cover: cover,
  blob: reader.result // üëà aqui
});

          loadDB(); // recarrega lista
        };

        reader.readAsArrayBuffer(file);
      },

      onError: () => {
        // fallback se n√£o ler metadata
        const reader = new FileReader();
        reader.onload = async () => {
          await saveMusic({
            title: file.name,
            artist: "Desconhecido",
            album: "",
            cover: null,
            blob: reader.result
          });

          loadDB();
        };

        reader.readAsArrayBuffer(file);
      }
    });
  });
};

function renderTracks(arr){
  list.innerHTML="";
  arr.forEach(t=>{
    const d=document.createElement("div");
    d.className="track";
    d.innerHTML=`
      <div class="cover">üéµ</div>
      <div class="info">
        <div class="title">${t.name}</div>
        <div class="artist">${t.artist}</div>
      </div>`;
    d.onclick = ()=>{
  audio.src = URL.createObjectURL(new Blob([t.blob]));
  audio.play();
  updateCover(t); // üî• agora a capa aparece
};
    list.appendChild(d);
  });
}

function search(txt){
  renderTracks(tracks.filter(t=>t.name.toLowerCase().includes(txt.toLowerCase())));
}
  function updateCover(track) {
  const coverDiv = document.getElementById("cover");

  if (track.cover) {
    coverDiv.innerHTML = `<img src="${track.cover}" alt="Capa">`;
  } else {
    coverDiv.textContent = "üéµ";
  }
  }

function setTab(tab,e){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  e.target.classList.add("active");

  if(tab==="tracks") renderTracks(tracks);
  if(tab==="artists"){
    const g={};
    tracks.forEach(t=>{
      g[t.artist]=g[t.artist]||[];
      g[t.artist].push(t);
    });
    list.innerHTML="";
    Object.keys(g).forEach(a=>{
      const d=document.createElement("div");
      d.className="track";
      d.innerHTML=`<div class="cover">üìÅ</div><div class="info"><div class="title">${a}</div></div>`;
      d.onclick=()=>renderTracks(g[a]);
      list.appendChild(d);
    });
  }
}

/* SERVICE WORKER */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(()=>console.log("SW OK"))
    .catch(err=>console.error(err));
}
</script>
  <script src="db.js"></script>

</body>
</html>
